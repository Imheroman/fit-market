<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.fitmarket_be.product.repository.ProductMapper">

    <resultMap id="ProductResultMap" type="com.ssafy.fitmarket_be.product.domain.Product">
        <constructor>
            <idArg column="id" javaType="long"/>
            <arg column="name" javaType="string"/>
            <arg column="description" javaType="string"/>
            <arg column="category_id" javaType="long"/>
            <arg column="category_name" javaType="string"/>
            <arg column="price" javaType="long"/>
            <arg column="stock" javaType="int"/>
            <arg column="image_url" javaType="string"/>
            <arg column="rating" javaType="double"/>
            <arg column="review_count" javaType="int"/>
            <arg column="calories" javaType="int"/>
            <arg column="protein" javaType="int"/>
            <arg column="carbs" javaType="int"/>
            <arg column="fat" javaType="int"/>
        </constructor>
    </resultMap>

    <!-- 상품 목록 조회 (필터링, 페이징, 최신순 정렬) -->
    <select id="selectProductsWithFilters" resultMap="ProductResultMap">
        SELECT
            p.id,
            p.name,
            p.description,
            p.price,
            p.stock,
            p.image_url,
            p.product_category_id AS category_id,
            pc.name AS category_name,
            p.rating,
            p.review_count,
            COALESCE(CAST(f.calories AS SIGNED), 0) AS calories,
            COALESCE(CAST(f.protein AS SIGNED), 0) AS protein,
            COALESCE(CAST(f.carbs AS SIGNED), 0) AS carbs,
            COALESCE(CAST(f.fat AS SIGNED), 0) AS fat
        FROM products p
        LEFT JOIN product_categories pc ON p.product_category_id = pc.id
        LEFT JOIN food f ON p.food_id = f.id
        WHERE p.deleted_date IS NULL
        <if test="categoryId != null">
          AND p.product_category_id = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
          AND (
            p.name LIKE CONCAT('%', #{keyword}, '%')
            OR p.description LIKE CONCAT('%', #{keyword}, '%')
            OR pc.name LIKE CONCAT('%', #{keyword}, '%')
            OR f.name LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(f.calories AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(f.protein AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(f.carbs AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(f.fat AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
          )
        </if>
        ORDER BY p.created_date DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 상품 개수 조회 (필터링) -->
    <select id="countProductsWithFilters" resultType="Long">
        SELECT COUNT(*)
        FROM products p
        LEFT JOIN product_categories pc ON p.product_category_id = pc.id
        LEFT JOIN food f ON p.food_id = f.id
        WHERE p.deleted_date IS NULL
        <if test="categoryId != null">
          AND p.product_category_id = #{categoryId}
        </if>
        <if test="keyword != null and keyword != ''">
          AND (
            p.name LIKE CONCAT('%', #{keyword}, '%')
            OR p.description LIKE CONCAT('%', #{keyword}, '%')
            OR pc.name LIKE CONCAT('%', #{keyword}, '%')
            OR f.name LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(f.calories AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(f.protein AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(f.carbs AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
            OR CAST(f.fat AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
          )
        </if>
    </select>

    <!-- 전체 상품 개수 조회 (삭제되지 않은 상품만) -->
    <select id="countProducts" resultType="Long">
        SELECT COUNT(*)
        FROM products
        WHERE deleted_date IS NULL
    </select>

    <!-- 상품 ID로 조회 -->
    <select id="selectProductById" resultMap="ProductResultMap">
        SELECT
            p.id,
            p.name,
            p.description,
            p.product_category_id AS category_id,
            pc.name AS category_name,
            p.price,
            p.stock,
            p.image_url,
            p.rating,
            p.review_count,
            COALESCE(CAST(f.calories AS SIGNED), 0) AS calories,
            COALESCE(CAST(f.protein AS SIGNED), 0) AS protein,
            COALESCE(CAST(f.carbs AS SIGNED), 0) AS carbs,
            COALESCE(CAST(f.fat AS SIGNED), 0) AS fat
        FROM products p
        LEFT JOIN product_categories pc ON p.product_category_id = pc.id
        LEFT JOIN food f ON p.food_id = f.id
        WHERE p.id = #{id}
          AND p.deleted_date IS NULL
    </select>

    <!-- 상품 등록 -->
    <insert id="insertProduct">
        INSERT INTO products (
            user_id,
            product_category_id,
            name,
            description,
            price,
            stock,
            image_url,
            rating,
            review_count,
            food_id
        ) VALUES (
            #{userId},
            #{categoryId},
            #{name},
            #{description},
            #{price},
            #{stock},
            #{imageUrl},
            0.0,
            0,
            #{foodId}
        )
    </insert>

    <!-- review_count 증가 -->
    <update id="incrementReviewCount">
        UPDATE products
        SET review_count = review_count + 1
        WHERE id = #{productId}
          AND deleted_date IS NULL
    </update>

    <!-- 마지막 삽입 ID 조회 -->
    <select id="selectLastInsertId" resultType="Long">
        SELECT LAST_INSERT_ID()
    </select>

    <!-- 상품 수정 -->
    <update id="updateProduct">
        UPDATE products
        SET name = #{name},
            product_category_id = #{categoryId},
            price = #{price},
            description = #{description},
            stock = #{stock},
            image_url = #{imageUrl}
        WHERE id = #{productId}
          AND deleted_date IS NULL
    </update>

    <!-- 상품 삭제 (소프트 삭제) -->
    <update id="deleteProduct">
        UPDATE products
        SET deleted_date = CURRENT_TIMESTAMP
        WHERE id = #{productId}
          AND deleted_date IS NULL
    </update>

    <!-- 판매자의 상품 목록 조회 (userId) -->
    <select id="selectProductsByUserId" resultMap="ProductResultMap">
        SELECT
            p.id,
            p.name,
            p.description,
            p.price,
            p.stock,
            p.image_url,
            p.product_category_id AS category_id,
            pc.name AS category_name,
            p.rating,
            p.review_count,
            COALESCE(CAST(f.calories AS SIGNED), 0) AS calories,
            COALESCE(CAST(f.protein AS SIGNED), 0) AS protein,
            COALESCE(CAST(f.carbs AS SIGNED), 0) AS carbs,
            COALESCE(CAST(f.fat AS SIGNED), 0) AS fat
        FROM products p
        LEFT JOIN product_categories pc ON p.product_category_id = pc.id
        LEFT JOIN food f ON p.food_id = f.id
        WHERE p.user_id = #{userId}
          AND p.deleted_date IS NULL
        ORDER BY p.created_date DESC
    </select>

    <!-- 베스트 상품 (평점 DESC, 리뷰수 DESC, 최신순) -->
    <select id="selectBestProducts" resultMap="ProductResultMap">
        SELECT
            p.id,
            p.name,
            p.description,
            p.price,
            p.stock,
            p.image_url,
            p.product_category_id AS category_id,
            pc.name AS category_name,
            p.rating,
            p.review_count,
            COALESCE(CAST(f.calories AS SIGNED), 0) AS calories,
            COALESCE(CAST(f.protein AS SIGNED), 0) AS protein,
            COALESCE(CAST(f.carbs AS SIGNED), 0) AS carbs,
            COALESCE(CAST(f.fat AS SIGNED), 0) AS fat
        FROM products p
        LEFT JOIN product_categories pc ON p.product_category_id = pc.id
        LEFT JOIN food f ON p.food_id = f.id
        WHERE p.deleted_date IS NULL
        ORDER BY p.rating DESC, p.review_count DESC, p.id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 신상품 (최신순) -->
    <select id="selectNewProducts" resultMap="ProductResultMap">
        SELECT
            p.id,
            p.name,
            p.description,
            p.price,
            p.stock,
            p.image_url,
            p.product_category_id AS category_id,
            pc.name AS category_name,
            p.rating,
            p.review_count,
            COALESCE(CAST(f.calories AS SIGNED), 0) AS calories,
            COALESCE(CAST(f.protein AS SIGNED), 0) AS protein,
            COALESCE(CAST(f.carbs AS SIGNED), 0) AS carbs,
            COALESCE(CAST(f.fat AS SIGNED), 0) AS fat
        FROM products p
        LEFT JOIN product_categories pc ON p.product_category_id = pc.id
        LEFT JOIN food f ON p.food_id = f.id
        WHERE p.deleted_date IS NULL
        ORDER BY p.id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

</mapper>
