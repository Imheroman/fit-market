<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.fitmarket_be.cart.repository.ShoppingCartRepository">

  <resultMap id="ShoppingCartProductResultMap" type="ShoppingCartProduct">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="productId" column="product_id"/>
    <result property="productName" column="product_name"/>
    <result property="categoryId" column="category_id"/>
    <result property="categoryName" column="category_name"/>
    <result property="price" column="price"/>
    <result property="quantity" column="quantity"/>
    <result property="imageUrl" column="image_url"/>
    <result property="calories" column="calories"/>
    <result property="protein" column="protein"/>
    <result property="carbs" column="carbs"/>
    <result property="fat" column="fat"/>
    <result property="createdDate" column="created_date"/>
    <result property="modifiedDate" column="modified_date"/>
  </resultMap>

  <select id="findActiveByUserId" resultMap="ShoppingCartProductResultMap">
    SELECT
      scp.id,
      scp.user_id,
      scp.product_id,
      scp.quantity,
      scp.created_date,
      scp.modified_date,
      p.name AS product_name,
      p.product_category_id AS category_id,
      pc.name AS category_name,
      p.price,
      p.image_url,
      COALESCE(CAST(f.calories AS SIGNED), 0) AS calories,
      COALESCE(CAST(f.protein AS SIGNED), 0) AS protein,
      COALESCE(CAST(f.carbs AS SIGNED), 0) AS carbs,
      COALESCE(CAST(f.fat AS SIGNED), 0) AS fat
    FROM shopping_cart_products scp
      JOIN products p ON scp.product_id = p.id
      LEFT JOIN product_categories pc ON p.product_category_id = pc.id
      LEFT JOIN food f ON p.food_id = f.id
    WHERE scp.user_id = #{userId}
      AND scp.deleted_date IS NULL
      AND p.deleted_date IS NULL
    ORDER BY scp.created_date DESC
  </select>

  <select id="countCartItems" resultType="int">
    SELECT
      COUNT(*)
    FROM shopping_cart_products scp
           JOIN products p ON scp.product_id = p.id
    WHERE scp.user_id = #{userId}
      AND scp.deleted_date IS NULL
      AND p.deleted_date IS NULL
  </select>

  <update id="incrementQuantity">
    UPDATE shopping_cart_products
    SET quantity = LEAST(quantity + #{quantity}, 100),
        modified_date = CURRENT_TIMESTAMP
    WHERE user_id = #{userId}
      AND product_id = #{productId}
      AND deleted_date IS NULL
  </update>

  <insert id="insert">
    INSERT INTO shopping_cart_products (user_id, product_id, quantity)
    VALUES (#{userId}, #{productId}, LEAST(#{quantity}, 100))
  </insert>

  <update id="updateQuantity">
    UPDATE shopping_cart_products
    SET quantity = LEAST(#{quantity}, 100),
        modified_date = CURRENT_TIMESTAMP
    WHERE id = #{cartItemId}
      AND user_id = #{userId}
      AND deleted_date IS NULL
  </update>

  <update id="softDelete">
    UPDATE shopping_cart_products
    SET deleted_date = CURRENT_TIMESTAMP,
        modified_date = CURRENT_TIMESTAMP
    WHERE id = #{cartItemId}
      AND user_id = #{userId}
      AND deleted_date IS NULL
  </update>
</mapper>
